---
const authorization = Astro.request.headers.get('authorization');
const pieces = authorization?.split(/\s+/g);
const basicAuth = () => {
  if (authorization && pieces && pieces[0] === 'Basic') {
    const buffer = Buffer.from(pieces[1], 'base64');
    const credentials = buffer.toString();
    const [username, password] = credentials.split(':');

    const result =
      username === import.meta.env.ADMIN_ID &&
      password === import.meta.env.ADMIN_PASSWORD
        ? true
        : false;

    if (result) {
      Astro.response.status = 200;
      Astro.response.headers.delete('WWW-Authenticate');
      Astro.response.headers.delete('Content-Length');
    }

    return result;
  } else {
    Astro.response.status = 401;
    Astro.response.headers.set('WWW-Authenticate', 'Basic realm="realm"');
    Astro.response.headers.set('Content-Length', '0');
    return false;
  }
};

const auth = basicAuth();
---

<>
  {
    auth ? (
      <slot />
    ) : (
      <div>
        <h1>401 Unauthorized</h1>
        <p>Authorization Required</p>
      </div>
    )
  }
</>
